function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}sap.ui.define("spet/data/explorer/ODataExplorer",["jquery.sap.global","sap/ui/core/Control","sap/ui/core/Component","sap/ui/model/odata/AnnotationHelper","spet/data/explorer/Graph","spet/data/explorer/ODataNode","spet/data/explorer/ODataLink"],function(e,t,a,r,d,p,o){"use strict";return t.extend("spet.data.explorer.ODataExplorer",{metadata:{properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},path:{type:"string",defaultValue:""},modelName:{type:"string",defaultValue:void 0},growingThreshold:{type:"int",defaultValue:20}},aggregations:{_graph:{type:"spet.data.explorer.Graph",multiple:!1,visibility:"hidden"}},events:{addEntity:{entityPath:{type:"string"},node:{type:"spet.data.explorer.Node"}},addNavigation:{navigationName:{type:"string"},entityPath:{type:"string"}},detailEntity:{dom:{type:"object"},entityPath:{type:"string"}},detailNavigation:{dom:{type:"object"},navigationName:{type:"string"},entityPath:{type:"string"}}}},_modelPromise:null,_link:function(e,t,a,r){var d=new o({sourceKey:t,targetKey:a,label:r||""});return e.addLink(d),d},_aggregation:function(t,a,r,d,s){var i=this,n=r+"/"+d,u=t.bindList(n).initialize(),l=0,x=this.getGrowingThreshold(),f=new e.Deferred,y=void 0,N=void 0,c=function(e){return e&&i._link(a,n,e.getKey())},D=function(){var e=new p({key:n,expanded:!0,label:s,entity:r});e.attachEvent("detail",function(e){i.fireEvent("detailNavigation",{dom:e.getParameter("dom"),entityPath:r,navigationName:d})}),a.addNode(e),f.resolve(e)},O=function(r){e.each(r,function(e,r){return i._entity(t,a,r.getPath(),!1).then(c)})},g=function(e){if(y&&(y.setBusy(!1),a.removeNode(y),a.removeLink(N)),(l+=x)<e){var t=n+"/__more";y=new p({key:t,label:sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("LOAD_MORE_DATA"),expanded:!1,entity:r,expand:K}),N=new o({sourceKey:n,targetKey:t}),a.addNode(y),a.addLink(N)}},m=function(){var e=u.getLength();e?(0===l&&D(),O(u.getContexts(l,x)),g(e)):(u.destroy(),f.resolve())},K=function(){var e=u.getContexts(l,x);e&&!e.dataRequested?m():y&&y.setBusy(!0)};return u.attachDataReceived(m),K(),f.promise()},_entity:function(t,a,d,o){var s=this,i=t&&t.getMetaModel(),n=new e.Deferred,u=function(){var e=i.getMetaContext(d),t=e.getPath()+"/com.sap.vocabularies.UI.v1.HeaderInfo/Title",a=i.createBindingContext(t);return a&&r.format(a)||e.getProperty("name")},l=function(e,t){return e&&s._link(a,d,e.getKey(),t)},x=function(e,t){var a=t+"/com.sap.vocabularies.Common.v1.Label",d=i.createBindingContext(a);return d&&r.format(d)||i.getProperty(t+"/name")},f=function(r,p,o){var i=s._entity(t,a,d+"/"+r,!1);return e.when(i,o).then(function(e){return l(e,p)}),i},y=function(r){var p=i.getMetaContext(d),o=p.getPath(),n=p.getObject(),u=new e.Deferred,y=r.getSource(),N=e.map(n.navigationProperty||[],function(r,p){var y=i.getODataAssociationEnd(n,r.name),N=x(r.name,o+"/navigationProperty/"+p),c=void 0;return s.fireEvent("addNavigation",{entityPath:d,navigationName:r.name},!0)?y.multiplicity.indexOf("*")>=0?(c=s._aggregation(t,a,d,r.name,N),e.when(c,u).then(l)):c=f(r.name,N,u):c=e.when(),c});e.when.apply(e,_toConsumableArray(N)).then(function(){return u.resolve()}),y.setBusy(!0),u.then(function(){return y.setBusy(!1)})},N=function(e,t){d=t.getPath(),e.setKey(d),e.setEntity(d),s.fireEvent("addEntity",{entityPath:d,node:e},!0)?(a.addNode(e),n.resolve(e)):n.resolve()},c=function(){var e=new p({origin:o||!1,label:u(),expanded:!1});e.bindElement(d),e.setModel(t),e.attachEventOnce("expand",y),e.attachEvent("detail",function(e){s.fireEvent("detailEntity",{dom:e.getParameter("dom"),entityPath:d})});var a=e.getElementBinding(),r=function(){var t=a.getBoundContext();return!!a.getBoundContext()&&(N(e,t),!0)};r()||a.attachEventOnce("dataReceived",function(){r()||n.resolve()})};return i&&i.loaded().then(c),n.promise()},init:function(){var t=this,r=new e.Deferred;this._modelPromise=r.promise(),this.setAggregation("_graph",new d({directed:!0})),this.attachModelContextChange(function(){var e=t.getModelName(),d=a.getOwnerComponentFor(t),p=t.getModel(e)||d&&d.getModel(e);p&&r.resolve(p)})},setPath:function(e){var t=this,a=this.getAggregation("_graph");return a.removeAllAggregation("nodes"),a.removeAllAggregation("links"),this.setProperty("path",e),this._modelPromise.then(function(r){return t._entity(r,a,e,!0)}),this},renderer:function(e,t){e.write("<div"),e.writeControlData(t),e.addStyle("height",t.getHeight()),e.addStyle("width",t.getWidth()),e.writeStyles(),e.write(">"),e.renderControl(t.getAggregation("_graph")),e.write("</div>")}})});