sap.ui.define("spet/data/explorer/Graph",["jquery.sap.global","sap/ui/core/Control","sap/ui/core/HTML","sap/ui/Device","sap/ui/thirdparty/d3","sap/ui/core/theming/Parameters"],function(e,t,a,r,d,p){"use strict";return t.extend("spet.data.explorer.Graph",{metadata:{properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},directed:{type:"boolean",defaultValue:!0}},aggregations:{_html:{type:"sap.ui.core.HTML",multiple:!1,visibility:"hidden"},nodes:{type:"spet.data.explorer.Node",multiple:!0},links:{type:"spet.data.explorer.Link",multiple:!0}},associations:{origins:{type:"spet.data.explorer.Node",multiple:!0}}},_force:null,_g:null,_size:{},init:function(){var t=this,d=new a({content:'<svg style="height:100%;width:100%"/>'});this.setAggregation("_html",d),d.attachAfterRendering(function(){t.draw(),e.sap.delayedCall(200,t,t.checkResize)}),r.resize.attachHandler(this.checkResize,this)},checkResize:function(){var t=this.getAggregation("_html").getDomRef();return!t||this._size.height===t.clientHeight&&this._size.width===t.clientWidth||(this.draw(),e.sap.delayedCall(200,this,this.checkResize)),this},initialize:function(e){var t=void 0,a=function(){e.select("g.links").selectAll("g.link").selectAll("line").attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),e.select("g.links").selectAll("g.link").selectAll("text").attr("transform",function(e){return"translate("+(e.source.x+e.target.x)/2+","+(e.source.y+e.target.y)/2+")"}),e.select("g.nodes").selectAll("g.node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"})};this._force=d.layout.force().linkDistance(function(e){return e.element.getLabel()?150:100}).charge(-200).gravity(.05).on("tick",a);var r=this._g=e.append("g");r.append("g").attr("class","links"),r.append("g").attr("class","nodes"),e.append("svg:defs").append("svg:marker").attr("id","arrow").attr("refX",7).attr("refY",4.5).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto").append("svg:path").attr("class","link").style("fill",p.get("sapButton_BorderColor")).attr("d","M 0 7 L 3.5 4.5 L 0 2"),t=d.behavior.zoom(),e.call(t.on("zoom",function(){r.attr("transform","translate("+d.event.translate+") scale("+d.event.scale+")")}))},data:function(){var e={},t=void 0,a=this.getDirected(),r={},d=this.getLinks()||[],p=this.getOrigins()||[],o=this.getNodes()||[],s={nodes:[],links:[]};return function(){for(var t=0;t<o.length;++t)e[o[t].getId()]=o[t],r[o[t].getId()]=[];p=p.map(function(t){return e[t]}).filter(function(e){return!!e})}(),function(){var t=void 0;if(a)for(t=0;t<d.length;++t)e.hasOwnProperty(d[t].getSource())&&e.hasOwnProperty(d[t].getTarget())&&r[d[t].getSource()].push(e[d[t].getTarget()]);else for(t=0;t<d.length;++t)e.hasOwnProperty(d[t].getSource())&&e.hasOwnProperty(d[t].getTarget())&&(r[d[t].getSource()].push(e[d[t].getTarget()]),r[d[t].getTarget()].push(e[d[t].getSource()]))}(),t=function(e,t,a){var r,d,p,o={},s=t.slice(0);for(p=0;p<e.length;++p)o[e[p].getId()]=!1;for(;s.length;)if(r=s.shift(),d=r.getId(),o[d]=!0,r.getExpanded())for(p=0;p<a[d].length;++p)o[a[d][p].getId()]||s.push(a[d][p]);return o}(o,p,r),function(){var a=void 0;for(a=0;a<o.length;++a)t[o[a].getId()]&&s.nodes.push(o[a]);for(a=0;a<d.length;++a)t[d[a].getSource()]&&t[d[a].getTarget()]&&s.links.push({source:e[d[a].getSource()],target:e[d[a].getTarget()],element:d[a]})}(),s},draw:function(){var e=this,t=this.getAggregation("_html").getDomRef();if(!t||!t.clientHeight||!t.clientWidth)return this;var a=void 0,r=void 0,o=d.svg.arc().innerRadius(2).outerRadius(4).startAngle(0).endAngle(2*Math.PI/3),s=function(){var e=d.interpolate(0,360);return function(t){return"rotate("+e(t)+")"}},i=function e(){(this.transition?this:d.select(this)).filter(function(e){return e.getBusy()}).transition().duration(2e3).ease("linear").attrTween("transform",s).each("end",e)};return function(){var o=e.data();e._size.height=t.clientHeight,e._size.width=t.clientWidth,t=d.select(t),null===e._g&&(e.initialize(t),t.style("background-color",p.get("sapBackgroundColor"))),e._force.size([e._size.width,e._size.height]).nodes(o.nodes).links(o.links).start(),a=t.select("g.links").selectAll("g.link").data(o.links,function(e){return e.target.getId()+"-"+e.source.getId()}),r=t.select("g.nodes").selectAll("g.node").data(o.nodes,function(e){return e.getId()})}(),function(){a.select("text").text(function(e){return e.element.getLabel()});var t=a.enter().append("g").attr("class","link");t.append("line").style("stroke-width",p.get("sapButton_BorderWidth")).style("stroke",p.get("sapButton_BorderColor")),t.append("text").attr("text-anchor","middle").text(function(e){return e.element.getLabel()}).style("font",p.get("sapUiFontSmallSize")+" "+p.get("sapUiFontCondensedFamily")).style("color",p.get("sapTextColor")).attr({"paint-order":"stroke",stroke:p.get("sapBackgroundColor"),"stroke-width":2,"stroke-linecap":"butt","stroke-linejoin":"miter"}),e.getDirected()&&t.filter(function(e){return!e.target.getLabelOnly()}).attr("marker-end","url(#arrow)"),a.exit().remove()}(),function(){r.select("circle").style("fill",function(e){return p.get(e.getExpanded()?"sapBackgroundColor":"sapSelectedColor")}),r.select("text").attr("dy",function(e){return e.getLabelOnly()?0:7}).attr("alignment-baseline",function(e){return e.getLabelOnly()?"middle":"hanging"}).text(function(e){return e.getLabel()}),r.select("title").text(function(e){return e.getTooltip()}),r.filter(function(e){return!e.getBusy()}).selectAll("path.busy").remove(),r.filter(function(e){return e.getBusy()&&d.select(this).selectAll("path.busy").empty()}).append("path").attr("d",o).attr("class","busy").attr("fill",p.get("sapSelectedColor")).call(i);var t=r.enter().append("g").attr("class","node").on("mousedown",function(){return d.event.stopPropagation()}).on("click",function(e){d.event.defaultPrevented||e.getLabelOnly()||!e.getExpandable()||e.getBusy()||(e.setExpanded(!e.getExpanded()),e.fireEvent("expand"))}).on("contextmenu",function(e){e.fireEvent("detail",{dom:this}),d.event.preventDefault()}).call(e._force.drag);t.filter(function(e){return!e.getLabelOnly()}).append("circle").style("fill",function(e){return p.get(e.getExpanded()?"sapBackgroundColor":"sapSelectedColor")}).style("stroke",p.get("sapButton_BorderColor")).style("stroke-width",p.get("sapButton_BorderWidth")).attr("r",4.5),t.append("text").attr("dy",function(e){return e.getLabelOnly()?0:7}).attr("alignment-baseline",function(e){return e.getLabelOnly()?"middle":"hanging"}).attr("text-anchor","middle").text(function(e){return e.getLabel()}).style("font",p.get("sapUiFontSmallSize")+" "+p.get("sapUiFontCondensedFamily")).style("color",p.get("sapTextColor")).attr({"paint-order":"stroke",stroke:p.get("sapBackgroundColor"),"stroke-width":2,"stroke-linecap":"butt","stroke-linejoin":"miter"}),t.append("title").text(function(e){return e.getTooltip()}),t.filter(function(e){return e.getBusy()}).append("path").attr("d",o).attr("class","busy").attr("fill",p.get("sapSelectedColor")).call(i),r.exit().remove()}(),this},renderer:function(e,t){e.write("<div"),e.writeControlData(t),e.addStyle("height",t.getHeight()),e.addStyle("width",t.getWidth()),e.writeStyles(),e.write(">"),e.renderControl(t.getAggregation("_html")),e.write("</div>")}})});